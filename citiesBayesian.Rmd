---
title: "Bayesian Cities Model"
author: "Dina Sinclair"
date: "June 9, 2018"
output: html_document
---

```{r, warning = FALSE}
library("rstan")
```

###Inputs

Given

$$Y = (Y_1, \dots, Y_i) $$
where each $Y_i$ has its own given $\sigma_{i,j}$,assume $Y \sim N(\theta_i, \sigma_{i,j})$.

For now, we'll use that classic arbitrary dataset I've been using
We'll hope that we can recover mu and tauSq correctly!
```{r, results='hide'}
set.seed(17)
mu <- 10
tauSq <- 2
I <- 3
J <- 3
sigmaSq <- c(0.1,1,.2)
theta <- rnorm(I, mu, tauSq)

# Here 1st row equal to theta(1), second row theta(2)... last row theta(I)
# Sigma varies by i (study) but not j (individual)
Y <- matrix( rnorm(I*J,mean=theta,sd=sigmaSq), I, J) 
basic_dat_generated <- list(J,I,Y,sigmaSq = list(sigmaSq, sigmaSq, sigmaSq))

theta
Y
```

### Step 1: Calculate $\theta_i, \mu, \tau^2$ using the original priors Y

$$\theta_i \sim N(\mu, \tau^2)$$

```{r}
fit <- stan(file = 'randomEffectsModelConstrainedI.stan', 
            data = basic_dat_generated, 
            iter = 1000, chains = 4)
fit
```


### Step 2: Pick $k$, calculate $Y'_k$

Then pick $k$ such that you get another draw, $Y'_k$ from that same fixed effects model. AKA

$$Y'_k \sim N(\theta_k, \sigma_{k,j})$$

### Step 3: Update all $Y$ values to get $Y^U$

Once those $k$ new values get calculated, update by combining to get 
$$update(Y_k, Y'_k) = Y^U_k$$

### Step 4: Use $Y^U$ to get final $\theta^U$

and once we have all the updated $Y_i^U$ we can use them to get $\theta_i^U$ based off of $\mu^U, \tau^{U2}$ with $Y^U \sim N(\theta^U_i, \sigma^U_{i,j})$ 







